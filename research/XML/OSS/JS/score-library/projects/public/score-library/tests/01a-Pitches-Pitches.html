<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>ScoreLibrary Unit Tests - 01a-Pitches-Pitches.xml</title>
<script src="../../closure-library/closure/goog/base.js"></script>
<script src="../scorelibrary-deps.js"></script> 
<script src="../../jquery/jquery-1.6.2.js"></script>
<script src="../../raphael/raphael.js"></script>
<script>
goog.require('goog.testing.AsyncTestCase');
goog.require('goog.testing.jsunit');
goog.require('ScoreLibrary.Score.Source');
goog.require('ScoreLibrary.Renderer.PaintContext.Canvas');
goog.require('ScoreLibrary.Renderer.Fonts.Gonville18');
//goog.require('ScoreLibrary.Renderer.Fonts.GonvilleBrace');
goog.require('ScoreLibrary.Engraver.Pager');
</script>
</head>
<body>
<script>
    var async_test_case = 
        new goog.testing.AsyncTestCase.createAndInstall("01a-Pitches-Pitches.xml");    

    function  pathToMusicXMLFile(file) {
	
	var path = location.href;

	var index = path.lastIndexOf('score-library');
	
	path = path.slice(0, index);
	
	path += 'musicxml/';	

	path += file;

	return path;
    };

    function callbackStreamScore(xml) {

	assertTrue(xml != undefined);

	var source = new ScoreLibrary.Score.Source(xml);
        
        var canvas_item = $('#canvas_test_score');

	var context = new ScoreLibrary.Renderer.PaintContext.Canvas(canvas_item);

	var custom_renderer =
	    context.getCustomTextRenderer();

	var glyph_factory = 
	    custom_renderer.getGlyphFactory();

	glyph_factory.addFont(ScoreLibrary.Renderer.Fonts.Gonville18);
//	glyph_factory.addFont(ScoreLibrary.Renderer.Fonts.GonvilleBrace);        

        var engraver = new ScoreLibrary.Engraver.Pager(context);
        
        var page_iterator = engraver.engrave(source);

        if (page_iterator.hasNext()) {

            var page = page_iterator.next();
            
            page.sizeAllocateRecursively({
            
                width: page.getRequisite('width'),
                height: page.getRequisite('height')
            });

	    ScoreLibrary.Renderer.PaintContext.debugPainting = false;
            
	    ScoreLibrary.Renderer.Paintable.debugDraw = false;
	    ScoreLibrary.Renderer.Paintable.debugDump = false;
//	    ScoreLibrary.Renderer.Paintable.debugId   = 35;   
            
            page.draw(context);
//          page.dump();            
        }
    };

    function testStreamScore() {

	$.ajax({
	    url: pathToMusicXMLFile("01a-Pitches-Pitches.xml"),
	    type: 'GET',
	    dataType: 'xml',
	    success: function (xml) {		

		callbackStreamScore(xml);

		async_test_case.continueTesting();		
	    },
	    error: function (jqXHR, textStatus, errorThrown) {
		
		alert(errorThrown.message);
	    }
	});

	async_test_case.waitForAsync();
    }
</script>
<div><p>01a-Pitches-Pitches.xml</p>
<canvas id='canvas_test_score' width='1600' height='2500'></canvas>
</div>
</body>
</html>
